<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>留言板</title>
    <link rel="stylesheet" href="/css/bootstrap.css">
    <style>
        body {
            width: 70%;
            margin: 20px auto;
        }
        h1{
            background: rgb(196, 243, 243);
            line-height:60px;
        }
        form {
            border: 1px solid rgb(144, 144, 250);
            padding: 10px;
            overflow: hidden;
            font-size: large;
            font-weight: bold;
        }
        form .p_right{
            text-align: right;
        }
        form .user{
            text-align: center;
            margin-top: 20px;
        }
        form .user img{
            width: 100px;
        }
        form input[type=text],textarea{
            width: 100%;
            border: rgb(163, 201, 236) 1px solid;
            margin-top: 10px;
        }
        form .btn{
            float: right;
        }

        .showMsg {
            display: flex;
            width: 100%;
            justify-content: space-between;
            flex-wrap: wrap;
        }

        .showMsg .out {
            float: left;
            width: 46%;
            border: 1px solid skyblue;
            padding: 10px 5px;
            background: rgb(240, 238, 238);
            margin: 2%;
        }
        .showMsg .out .img img{
            width: 50px;
        }

        .out p:first-child span {
            color: red;
            font-size: 18px;
        }
        .out p:last-child{
            text-align: right;
        }

        .out .message {
            background: white;
            padding: 20px 0;
        }

        .out textarea {
            width: 100%;
            margin: 0;
            padding: 0;
            border: 0;
            outline: 0;
        }

        .pager .up {
            margin: 0;
        }

        .last {
            background-color: rgb(205, 242, 243);
            border: none;
            padding: 5px;
        }
        .pager .active a{
            background: #c6f3f5
        }
    </style>
</head>

<body>
    <h1 align="center">留言板</h1>
    <form action="/message/tijiao" method="post" onsubmit="">
        <div class="p_right">
            <a href="/user/logout">退出登录</a>
            <a href="/user/center">个人中心</a>
        </div>
        <div class="user">
            <% for(var i = 0; i<users.length;i++){ %>
                <% if(username == users[i].username){ %>
                    <div class="avatar">
                        <img src="<%= users[i].avatar %>" >
                    </div>
                    <div class="nickname">
                        <h2><%= users[i].nickname %></h2>
                    </div>
                <% } %>
            <% } %>
        </div>
        
        <p><%= username %></p>  
        留言: <p><textarea name="message"></textarea></p>
        <input type="submit" class="btn btn-info">
    </form>
    <hr>
    <ul class="pager up">
        <li class="<%= current==1?'disabled':'' %>">
            <a href="/message?page=<%= current==1?1:current-1 %>" aria-label="Previous" >
                <span aria-hidden="true">&laquo;</span>
            </a>
        </li>
        <% for(var i=0;i<pages;i++){ %>
        <li class="<%= current==i+1?'active':'' %>">
            <a href="/message?page=<%= i+1 %>"><%= i+1 %></a>
        </li>
        <% } %>
        <li class="<%= current==pages?'disabled':'' %>">
            <a href="/message?page=<%= current==pages?current:current+1 %>" aria-label="Next">
                <span aria-hidden="true">&raquo;</span>
            </a>
        </li>
    </ul>
    <div class="showMsg">
        <% for(var i=0;i<msg.length;i++){ %>
            <% for(var j=0;j<users.length;j++){ %>
                <% if(msg[i].username==users[j].username){ %>
                <div class="out">
                    <div class="img">
                        <img src="<%= users[j].avatar %>">
                    </div>
                    <div class="msg">
                        <p><span><%= users[j].nickname %></span> 说</p>
                        <p class="message"><%= msg[i].message %></p>
                        <p><%= msg[i].date %></p>
                        <% if(username==msg[i].username){ %>
                        <p>
                            <a href="javascript:;" onclick='modify(this)'>编辑</a>&nbsp;&nbsp;&nbsp;
                            <a href="javascript:;" onclick='del("<%= msg[i]._id %>")'>删除</a>
                        </p>
                        <%}%>
                    </div>

                </div>
                <% } %>
            <% } %>
        <% } %>
    </div>
    <div class="out last">
        <ul class="pager">
            <li class="<%= current==1?'disabled':'' %>"><a href="/message?page=<%= current==1?1:current-1 %>">Previous</a></li>
            <li class="<%= current==pages?'disabled':'' %>"><a href="/message?page=<%= current==pages?current:current+1 %>">Next</a></li>
        </ul>
    </div>

    <script src="/js/jquery.min.js"></script>
    <script>
        var oldMsg = '';//保存旧的留言信息
        var canSend = false;//是否可以发送请求
        var id = '';//被修改信息的id

        // 修改第一步:将信息区域替换成文本域
        function modify(i) {
            var $div = $(i).parent().prev().prev();
            // 保存旧留言
            oldMsg = $div.html();
            $div.html('<textarea onblur="send(this)">' + oldMsg + '</textarea>');

            // 自动获取焦点
            $div.find('textarea').focus();
        }
        // 修改第二步:发送请求
        function send(i) {
            var val = $(i).val().trim();
            if (val == '') {
                // alert('数据不能为空');
                // 将原来的数据重新填入
                $(i).parent().html(oldMsg);
                oldMsg = '';//重置全局变量
                return;
            }
            // 修改数据
            // 取id
            var id = $(i).parent().parent().find('a:contains("删除")').attr('onclick');
            id = id.substring(id.indexOf('"') + 1, id.lastIndexOf('"'));
            // console.log(id);
            $.ajax({
                url: '/message/modify',
                data: { id: id, message: val },
                method: 'post',
                                                                success: function (result) {
                    if (result.status == 1) {
                        alert(result.msg);
                        return;
                    }
                    if (result.status == 2) {
                        alert(result.msg);
                    }
                    // 修改成功,将文本框替换为新的内容
                    $(i).parent().html(val.replace('\n', '<br>'));
                    oldMsg = '';//重置
                }
            })

        }


        // 删除
        function del(id) {
            var f = confirm('是否要删除该留言?');
            if (!f) {
                return;
            }
            // 确认删除
            $.ajax({
                url: '/message/del?id=' + id,
                success: function (result) {
                    if (result.status == 1) {
                        alert(result.msg);
                        return;
                    }
                    // 删除成功
                    location.href = '/';
                }
            })
        }
    </script>
</body>

</html>